<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Library - 2FA Authentication</title>
  <script async src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
    .page { display: none; } .page.active { display: block; }

    /* Login Page */
    .login-page {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .login-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      max-width: 450px;
      width: 100%;
    }

    .login-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 20px;
      text-align: center;
    }

    .login-header h1 { font-size: 32px; margin-bottom: 10px; }
    .login-header p { font-size: 14px; opacity: 0.9; }

    .login-body { padding: 40px 30px; }

    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }

    input[type="email"], input[type="password"], input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }

    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
    .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }

    .btn-secondary { background: #6c757d; margin-top: 10px; }
    .btn-secondary:hover { background: #5a6268; }

    .btn-link { 
      background: none; 
      color: #667eea; 
      text-decoration: underline; 
      padding: 0; 
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
    }
    .btn-link:hover { color: #764ba2; }

    .message {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      display: none;
      text-align: center;
      font-size: 14px;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .loading {
      display: none;
      text-align: center;
      margin-top: 15px;
      color: #667eea;
      font-weight: 600;
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 30px;
      gap: 10px;
    }

    .step {
      flex: 1;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
    }

    .step.active { background: #667eea; }

    .registration-page {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .registration-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .registration-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px 20px;
      text-align: center;
    }

    .registration-body { padding: 40px 30px; }

    .photo-section {
      margin: 20px 0;
      padding: 20px;
      border: 2px dashed #667eea;
      border-radius: 8px;
      background: #f9f9f9;
      text-align: center;
    }

    .photo-preview {
      width: 150px;
      height: 150px;
      margin: 10px auto;
      border-radius: 8px;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .photo-preview img, .photo-preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .camera-controls button {
      flex: 1;
      min-width: 110px;
      padding: 8px;
      font-size: 12px;
    }

    /* Dashboard */
    .dashboard-page { background: #f5f5f5; }

    .dashboard-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dashboard-header h1 { font-size: 24px; }

    .user-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logout-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .logout-btn:hover { background: rgba(255, 255, 255, 0.3); }

    .dashboard-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      margin-bottom: 20px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .profile-info { display: flex; flex-direction: column; gap: 15px; }
    .profile-item label { font-size: 12px; color: #999; font-weight: 600; }
    .profile-item value { font-size: 16px; color: #333; font-weight: 600; }

    .stat { text-align: center; margin: 15px 0; }
    .stat-value { font-size: 36px; font-weight: bold; color: #667eea; }
    .stat-label { color: #999; font-size: 12px; margin-top: 5px; }

    .book-card {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      border-left: 4px solid #667eea;
      cursor: pointer;
      transition: all 0.3s;
    }

    .book-card:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }

    .book-title { font-weight: 600; color: #333; margin-bottom: 5px; }
    .book-author { font-size: 13px; color: #666; margin-bottom: 3px; }
    .book-category { font-size: 12px; color: #999; margin-bottom: 10px; }

    .borrow-btn {
      width: 100%;
      padding: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }

    .borrow-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
    .borrow-btn:disabled { background: #ccc; cursor: not-allowed; }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .close-btn { background: none; border: none; font-size: 28px; color: #999; cursor: pointer; }
    .close-btn:hover { color: #333; }

    video { width: 100%; border-radius: 8px; margin: 15px 0; }
    canvas { display: none; }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div class="login-page page active" id="loginPage">
    <div class="login-container">
      <div class="login-header">
        <h1>üìö Smart Library</h1>
        <p>2-Factor Authentication</p>
      </div>

      <div class="login-body">
        <div class="step-indicator">
          <div class="step active" id="step1"></div>
          <div class="step" id="step2"></div>
        </div>

        <!-- Step 1: Email & Password -->
        <div id="emailPasswordForm">
          <h3 style="margin-bottom: 20px; color: #333;">Step 1: Login</h3>
          <div class="form-group">
            <label for="email">Email Address</label>
            <input type="email" id="email" placeholder="your.email@niituniversity.in">
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <button class="btn" onclick="handleEmailPasswordLogin()">Next: Facial Recognition</button>
          <div class="loading" id="emailLoading">Processing...</div>
          <div class="message" id="emailMessage"></div>
          <button class="btn btn-link" onclick="switchToRegistration()">New User? Create Account</button>
        </div>

        <!-- Step 2: Facial Recognition -->
        <div id="facialRecognitionForm" style="display: none;">
          <h3 style="margin-bottom: 20px; color: #333;">Step 2: Facial Recognition</h3>
          <p style="color: #666; margin-bottom: 15px; font-size: 14px;">Enable your camera for facial verification</p>
          
          <video id="video" style="display: none;" autoplay muted></video>
          <canvas id="canvas"></canvas>
          <div id="capturedImageDisplay" style="width: 100%; border-radius: 8px; background: #f0f0f0; margin-bottom: 15px; min-height: 250px; display: flex; align-items: center; justify-content: center; color: #999;">Camera preview will appear here</div>
          
          <div class="camera-controls">
            <button class="btn" onclick="startFacialCapture()">Start Camera</button>
            <button class="btn" onclick="captureFace()">Capture Face</button>
          </div>

          <button class="btn" onclick="handleFacialRecognition()" id="verifyFacialBtn" style="display: none; margin-top: 15px;">Complete Login</button>
          <button class="btn btn-secondary" onclick="backToEmailPassword()">Back</button>
          <div class="loading" id="facialLoading">Processing...</div>
          <div class="message" id="facialMessage"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Registration Page -->
  <div class="registration-page page" id="registrationPage">
    <div class="registration-container">
      <div class="registration-header">
        <h1>üìö Create Account</h1>
        <p>Join Smart Library System</p>
      </div>

      <div class="registration-body">
        <div class="form-group">
          <label for="regName">Full Name</label>
          <input type="text" id="regName" placeholder="Your full name">
        </div>

        <div class="form-group">
          <label for="regEnrollment">Enrollment ID (Optional)</label>
          <input type="text" id="regEnrollment" placeholder="Your enrollment ID">
        </div>

        <div class="form-group">
          <label for="regEmail">Email Address</label>
          <input type="email" id="regEmail" placeholder="your.email@niituniversity.in">
        </div>

        <div class="form-group">
          <label for="regPassword">Password</label>
          <input type="password" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>

        <div class="form-group">
          <label for="regConfirmPassword">Confirm Password</label>
          <input type="password" id="regConfirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>

        <div class="photo-section">
          <h4 style="margin-bottom: 10px; color: #333;">Upload Your Photo</h4>
          <p style="color: #999; font-size: 12px; margin-bottom: 15px;">This will be used for facial recognition</p>
          
          <div class="photo-preview" id="photoPreview">
            <span>üì∑ No photo yet</span>
          </div>

          <div class="camera-controls">
            <button class="btn" onclick="startPhotoCapture()">Start Camera</button>
            <button class="btn" onclick="capturePhoto()">Capture Photo</button>
            <button class="btn btn-secondary" onclick="stopPhotoCapture()">Stop</button>
          </div>

          <div class="message" id="photoMessage"></div>
        </div>

        <button class="btn" onclick="handleRegistration()">Create Account</button>
        <button class="btn btn-secondary" onclick="switchToLogin()">Back to Login</button>

        <div class="loading" id="registrationLoading">Creating account...</div>
        <div class="message" id="registrationMessage"></div>
      </div>
    </div>
  </div>

  <!-- Dashboard Page -->
  <div class="dashboard-page page" id="dashboardPage">
    <div class="dashboard-header">
      <h1>üìö Smart Library Dashboard</h1>
      <div class="user-section">
        <div>
          <div style="font-size: 14px; opacity: 0.9;">Welcome</div>
          <div id="dashboardUserName" style="font-weight: 600;"></div>
        </div>
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
      </div>
    </div>

    <div class="dashboard-container">
      <div class="dashboard-grid">
        <div class="card">
          <h2>Profile</h2>
          <div class="profile-info">
            <div class="profile-item">
              <label>Enrollment ID</label>
              <value id="profileEnrollmentId"></value>
            </div>
            <div class="profile-item">
              <label>Full Name</label>
              <value id="profileName"></value>
            </div>
            <div class="profile-item">
              <label>Email</label>
              <value id="profileEmail"></value>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Library Statistics</h2>
          <div class="stat">
            <div class="stat-value" id="totalBooksCount">0</div>
            <div class="stat-label">Total Books</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="borrowedBooksCount">0</div>
            <div class="stat-label">Borrowed</div>
          </div>
        </div>

        <div class="card">
          <h2>Available Books</h2>
          <div id="availableBooksGrid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scan Modal -->
  <div class="modal" id="scanModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="scanTitle">Scan Book Barcode</h2>
        <button class="close-btn" onclick="closeScanModal()">&times;</button>
      </div>

      <video id="scanVideo"></video>
      <canvas id="scanCanvas"></canvas>
      <button class="btn" onclick="startBarcodeScanning()">Start Scanning</button>
      <button class="btn btn-secondary" onclick="closeScanModal()">Close</button>

      <div class="message" id="scanMessage"></div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    let currentUserId = null;
    let currentUser = null;
    let facialData = null;
    let photoData = null;
    let stream = null;
    let scanStream = null;
    let selectedBook = null;
    let facialDescriptor = null;  // Store facial descriptor from Face-API

    // Load Face-API models
    let modelsLoaded = false;
    let modelsLoading = false;
    let faceApiAvailable = false;

    async function loadFaceModels() {
      if (modelsLoaded) return true;
      if (modelsLoading) {
        let attempts = 0;
        while (!modelsLoaded && modelsLoading && attempts < 600) {  // 60 second timeout
          await new Promise(r => setTimeout(r, 100));
          attempts++;
        }
        return modelsLoaded;
      }

      modelsLoading = true;
      
      try {
        if (typeof faceapi === 'undefined') {
          console.warn('Face-API library not yet loaded from CDN');
          modelsLoading = false;
          return false;
        }

        faceApiAvailable = true;
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
        
        console.log('üîÑ Loading Face-API models from CDN...');
        
        await Promise.all([
          faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
          faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
          faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        
        modelsLoaded = true;
        console.log('‚úÖ Face-API models loaded successfully');
        return true;
      } catch (error) {
        console.error('‚ùå Error loading Face-API models:', error.message);
        modelsLoaded = false;
        return false;
      } finally {
        modelsLoading = false;
      }
    }

    // Load models on startup
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', async () => {
        console.log('üöÄ Initializing Face-API on page load...');
        await loadFaceModels();
      });
    } else {
      loadFaceModels();
    }

    // Also try on window load
    window.addEventListener('load', async () => {
      if (!modelsLoaded && !modelsLoading) {
        console.log('üîÑ Attempting Face-API models load on window load...');
        await loadFaceModels();
      }
    });

    // Helper function to validate and convert base64 if needed
    function ensureBase64(data) {
      if (!data) return null;
      if (typeof data === 'string' && (data.startsWith('data:') || data.startsWith('/9j'))) {
        return data;
      }
      return data;
    }

    // Extract facial descriptor using Face-API (NO FALLBACK - STRICT MODE)
    async function extractFacialDescriptor(canvas) {
      try {
        // Wait for models to load - CRITICAL: models MUST be loaded
        if (!modelsLoaded) {
          console.log('‚è≥ Waiting for Face-API models to load...');
          let attempts = 0;
          const maxAttempts = 600; // 60 seconds
          while (!modelsLoaded && attempts < maxAttempts) {
            await new Promise(r => setTimeout(r, 100));
            attempts++;
          }
          
          if (!modelsLoaded) {
            console.error(`‚ùå CRITICAL: Face-API models failed to load after ${maxAttempts} attempts (60 seconds)`);
            return null;
          }
        }

        // Double-check Face-API availability
        if (typeof faceapi === 'undefined') {
          console.error('‚ùå CRITICAL: Face-API library not available');
          return null;
        }

        if (!faceapi.nets || !faceapi.nets.tinyFaceDetector) {
          console.error('‚ùå CRITICAL: Face-API networks not initialized');
          return null;
        }

        console.log('üîç Detecting face with TinyFaceDetector...');
        
        const detections = await faceapi
          .detectAllFaces(canvas, new faceapi.TinyFaceDetectorOptions({ inputSize: 416 }))
          .withFaceLandmarks()
          .withFaceDescriptors();

        console.log(`‚úÖ Found ${detections.length} face(s)`);

        if (detections.length === 0) {
          console.warn('‚ùå No face detected in image - ensure good lighting and your entire face is visible');
          return null;
        }

        const descriptor = detections[0].descriptor;
        
        // VALIDATION: Descriptor must be exactly 128D
        if (!descriptor || descriptor.length !== 128) {
          console.error(`‚ùå CRITICAL: Invalid descriptor size ${descriptor?.length || 'null'}D - expected 128D`);
          return null;
        }

        console.log(`‚úÖ Extracted valid 128D descriptor: [${Array.from(descriptor).slice(0, 5).map(v => v.toFixed(3)).join(', ')}...]`);
        return descriptor;
      } catch (error) {
        console.error('‚ùå Error extracting facial descriptor:', error.message);
        console.error('   Stack:', error.stack);
        return null;  // STRICT: NO FALLBACK - return null on error
      }
    }

    // ============= AUTHENTICATION FUNCTIONS =============

    function switchToRegistration() {
      document.getElementById('loginPage').classList.remove('active');
      document.getElementById('registrationPage').classList.add('active');
    }

    function switchToLogin() {
      document.getElementById('registrationPage').classList.remove('active');
      document.getElementById('loginPage').classList.add('active');
      resetLoginForm();
    }

    function resetLoginForm() {
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
      document.getElementById('emailPasswordForm').style.display = 'block';
      document.getElementById('facialRecognitionForm').style.display = 'none';
      document.getElementById('step1').classList.add('active');
      document.getElementById('step2').classList.remove('active');
      facialData = null;
      document.getElementById('verifyFacialBtn').style.display = 'none';
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    async function handleEmailPasswordLogin() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const message = document.getElementById('emailMessage');
      const loading = document.getElementById('emailLoading');

      if (!email || !password) {
        message.textContent = 'Please enter email and password';
        message.className = 'message error';
        return;
      }

      loading.style.display = 'block';
      message.style.display = 'none';

      try {
        const response = await fetch(`${API_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (data.success) {
          currentUserId = data.user_id;
          message.textContent = '‚úì Password verified! Proceed to facial recognition.';
          message.className = 'message success';
          message.style.display = 'block';

          setTimeout(() => {
            document.getElementById('emailPasswordForm').style.display = 'none';
            document.getElementById('facialRecognitionForm').style.display = 'block';
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
          }, 1500);
        } else {
          message.textContent = data.message || 'Login failed';
          message.className = 'message error';
          message.style.display = 'block';
        }
      } catch (error) {
        message.textContent = 'Error: ' + error.message;
        message.className = 'message error';
        message.style.display = 'block';
      } finally {
        loading.style.display = 'none';
      }
    }

    async function startFacialCapture() {
      const video = document.getElementById('video');
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.style.display = 'block';
        video.play();
        document.getElementById('capturedImageDisplay').innerHTML = '<video id="previewVideo" autoplay muted style="width: 100%; border-radius: 8px;"></video>';
        document.getElementById('previewVideo').srcObject = stream;
      } catch (error) {
        document.getElementById('facialMessage').textContent = 'Camera access denied: ' + error.message;
        document.getElementById('facialMessage').className = 'message error';
      }
    }

    async function captureFace() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const message = document.getElementById('facialMessage');
      
      if (!stream) {
        message.textContent = 'Please start camera first';
        message.className = 'message error';
        return;
      }

      message.textContent = '‚è≥ Processing your face...';
      message.className = 'message success';

      try {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);

        console.log('Capturing face from canvas:', canvas.width, 'x', canvas.height);
        
        // Extract facial descriptor using Face-API
        facialDescriptor = await extractFacialDescriptor(canvas);
        
        if (!facialDescriptor) {
          message.textContent = '‚ùå No face detected. Please ensure:\n‚Ä¢ Your face is clearly visible\n‚Ä¢ Good lighting on your face\n‚Ä¢ Your entire face is in frame\n\nTry again!';
          message.className = 'message error';
          return;
        }

        facialData = canvas.toDataURL('image/jpeg');
        document.getElementById('capturedImageDisplay').innerHTML = `<img src="${facialData}" style="width: 100%; border-radius: 8px;">`;
        
        message.textContent = `‚úÖ Face captured successfully! (${facialDescriptor.length}D descriptor)`;
        message.className = 'message success';
        
        document.getElementById('verifyFacialBtn').style.display = 'block';
        
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
        }
      } catch (error) {
        console.error('Error in captureFace:', error);
        message.textContent = 'Error: ' + error.message + '\nPlease try again.';
        message.className = 'message error';
      }
    }

    async function handleFacialRecognition() {
      const message = document.getElementById('facialMessage');
      const loading = document.getElementById('facialLoading');

      if (!facialData || !facialDescriptor) {
        message.textContent = 'Please capture your face first';
        message.className = 'message error';
        return;
      }

      loading.style.display = 'block';
      message.style.display = 'none';

      try {
        // Send facial descriptor (not image) to backend for verification
        const response = await fetch(`${API_URL}/verify-otp`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            user_id: currentUserId, 
            facial_descriptor: Array.from(facialDescriptor),  // Convert to array
            facial_data: ensureBase64(facialData) 
          })
        });

        const data = await response.json();

        if (data.success) {
          currentUser = data.user;
          message.textContent = '‚úì Facial recognition successful! Similarity: ' + (data.similarity * 100).toFixed(1) + '%';
          message.className = 'message success';
          message.style.display = 'block';

          setTimeout(() => {
            showDashboard();
          }, 1500);
        } else {
          message.textContent = data.message || 'Facial recognition failed';
          message.className = 'message error';
          message.style.display = 'block';
        }
      } catch (error) {
        message.textContent = 'Error: ' + error.message;
        message.className = 'message error';
        message.style.display = 'block';
      } finally {
        loading.style.display = 'none';
      }
    }

    function backToEmailPassword() {
      document.getElementById('facialRecognitionForm').style.display = 'none';
      document.getElementById('emailPasswordForm').style.display = 'block';
      document.getElementById('step2').classList.remove('active');
      document.getElementById('step1').classList.add('active');
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    // ============= REGISTRATION FUNCTIONS =============

    async function startPhotoCapture() {
      const preview = document.getElementById('photoPreview');
      const video = document.createElement('video');
      video.setAttribute('autoplay', '');
      video.setAttribute('muted', '');
      video.style.width = '100%';
      video.style.borderRadius = '8px';

      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        preview.innerHTML = '';
        preview.appendChild(video);
      } catch (error) {
        document.getElementById('photoMessage').textContent = 'Camera access denied: ' + error.message;
        document.getElementById('photoMessage').className = 'message error';
      }
    }

    function capturePhoto() {
      const preview = document.getElementById('photoPreview');
      const video = preview.querySelector('video');
      const message = document.getElementById('photoMessage');

      if (!video || !stream) {
        message.textContent = 'Please start camera first';
        message.className = 'message error';
        return;
      }

      const canvas = document.getElementById('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);

      photoData = canvas.toDataURL('image/jpeg');
      preview.innerHTML = `<img src="${photoData}" style="width: 100%; border-radius: 8px;">`;

      message.textContent = '‚è≥ Analyzing your face...';
      message.className = 'message success';

      // Extract facial descriptor for registration
      extractFacialDescriptor(canvas).then(descriptor => {
        if (descriptor) {
          facialDescriptor = descriptor;
          message.textContent = '‚úì Photo captured! Face detected (Descriptor: ' + descriptor.length + 'D)';
          message.className = 'message success';
        } else {
          message.textContent = '‚ùå Face not detected. Please ensure:\n‚Ä¢ Your face is clearly visible\n‚Ä¢ Good lighting\n‚Ä¢ Try again with different angle';
          message.className = 'message error';
          photoData = null;  // Reset if face not detected
        }
      }).catch(err => {
        console.error('Error analyzing face:', err);
        message.textContent = 'Error analyzing face: ' + err.message;
        message.className = 'message error';
      });
    }

    function stopPhotoCapture() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
    }

    async function handleRegistration() {
      const name = document.getElementById('regName').value.trim();
      const enrollment_id = document.getElementById('regEnrollment').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value.trim();
      const confirmPassword = document.getElementById('regConfirmPassword').value.trim();
      const message = document.getElementById('registrationMessage');
      const loading = document.getElementById('registrationLoading');

      if (!name || !email || !password || !confirmPassword) {
        message.textContent = 'Please fill all required fields';
        message.className = 'message error';
        return;
      }

      if (password !== confirmPassword) {
        message.textContent = 'Passwords do not match';
        message.className = 'message error';
        return;
      }

      if (!photoData) {
        message.textContent = 'Please capture a photo';
        message.className = 'message error';
        return;
      }

      if (!facialDescriptor) {
        message.textContent = 'Please ensure your face is detected and captured';
        message.className = 'message error';
        return;
      }

      loading.style.display = 'block';
      message.style.display = 'none';

      try {
        const response = await fetch(`${API_URL}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            enrollment_id: enrollment_id || null,
            email,
            password,
            facial_descriptor: Array.from(facialDescriptor),  // Send facial descriptor
            facial_data: ensureBase64(photoData),
            image: ensureBase64(photoData)
          })
        });

        const data = await response.json();

        if (data.success) {
          message.textContent = '‚úì Account created! Redirecting to login...';
          message.className = 'message success';
          message.style.display = 'block';

          setTimeout(() => {
            document.getElementById('registrationForm').reset?.();
            photoData = null;
            facialDescriptor = null;
            document.getElementById('photoPreview').innerHTML = '<span>üì∑ No photo yet</span>';
            switchToLogin();
          }, 2000);
        } else {
          message.textContent = data.message || 'Registration failed';
          message.className = 'message error';
          message.style.display = 'block';
        }
      } catch (error) {
        message.textContent = 'Error: ' + error.message;
        message.className = 'message error';
        message.style.display = 'block';
      } finally {
        loading.style.display = 'none';
      }
    }

    // ============= DASHBOARD FUNCTIONS =============

    function showDashboard() {
      document.getElementById('loginPage').classList.remove('active');
      document.getElementById('dashboardPage').classList.add('active');
      
      document.getElementById('dashboardUserName').textContent = currentUser.name;
      document.getElementById('profileEnrollmentId').textContent = currentUser.enrollment_id || 'N/A';
      document.getElementById('profileName').textContent = currentUser.name;
      document.getElementById('profileEmail').textContent = currentUser.email;

      loadBooks();
    }

    async function loadBooks() {
      try {
        const response = await fetch(`${API_URL}/books`);
        const books = await response.json();

        document.getElementById('totalBooksCount').textContent = books.length;

        const grid = document.getElementById('availableBooksGrid');
        grid.innerHTML = '';

        books.forEach(book => {
          const isAvailable = book.available > 0;
          const card = document.createElement('div');
          card.className = 'book-card';
          card.innerHTML = `
            <div class="book-title">${book.title}</div>
            <div class="book-author">by ${book.author}</div>
            <div class="book-category">${book.category}</div>
            <button class="borrow-btn" onclick="prepareBorrow(${book.id}, '${book.title}')" ${!isAvailable ? 'disabled' : ''}>
              ${isAvailable ? 'üì§ Borrow' : '‚ùå Unavailable'}
            </button>
          `;
          grid.appendChild(card);
        });
      } catch (error) {
        console.error('Error loading books:', error);
      }
    }

    function prepareBorrow(bookId, bookTitle) {
      selectedBook = { id: bookId, title: bookTitle };
      document.getElementById('scanTitle').textContent = `Scan: ${bookTitle}`;
      document.getElementById('scanModal').classList.add('active');
    }

    async function startBarcodeScanning() {
      const video = document.getElementById('scanVideo');
      try {
        scanStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });
        video.srcObject = scanStream;
        video.setAttribute('playsinline', 'true');
        video.play().catch(err => {
          console.error('Error playing video:', err);
          document.getElementById('scanMessage').textContent = 'Error accessing camera: ' + err.message;
          document.getElementById('scanMessage').className = 'message error';
        });
        
        document.getElementById('scanMessage').textContent = 'üì∑ Camera active - scanning for barcode...';
        document.getElementById('scanMessage').className = 'message success';
        
        scanBarcodeLoop();
      } catch (error) {
        console.error('Camera access error:', error);
        document.getElementById('scanMessage').textContent = 'Camera access denied: ' + error.message + '. Please check camera permissions.';
        document.getElementById('scanMessage').className = 'message error';
      }
    }

    function scanBarcodeLoop() {
      const video = document.getElementById('scanVideo');
      const canvas = document.getElementById('scanCanvas');

      if (!video.srcObject) return;

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const imageData = canvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);

      if (code) {
        document.getElementById('scanMessage').textContent = '‚úì Barcode: ' + code.data;
        document.getElementById('scanMessage').className = 'message success';
        closeScanModal();
      } else if (scanStream) {
        requestAnimationFrame(scanBarcodeLoop);
      }
    }

    function closeScanModal() {
      document.getElementById('scanModal').classList.remove('active');
      if (scanStream) {
        scanStream.getTracks().forEach(track => track.stop());
        scanStream = null;
      }
    }

    function handleLogout() {
      currentUserId = null;
      currentUser = null;
      facialData = null;
      resetLoginForm();
      document.getElementById('dashboardPage').classList.remove('active');
      document.getElementById('loginPage').classList.add('active');
    }
  </script>
</body>
</html>
